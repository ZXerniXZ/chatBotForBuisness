<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Chatbot Officina Panarari</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
        .container { max-width: 500px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px; }
        h2 { text-align: center; color: #333; }
        .session-controls { display: flex; gap: 8px; margin-bottom: 16px; align-items: center; }
        .session-controls input { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #bbb; }
        .session-controls button { padding: 8px 12px; border-radius: 6px; border: none; background: #dc3545; color: #fff; font-weight: bold; cursor: pointer; }
        .session-controls button:hover { background: #c82333; }
        #chat { height: 350px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 12px; background: #fafafa; margin-bottom: 16px; }
        .msg { margin-bottom: 12px; }
        .user { color: #1976d2; font-weight: bold; }
        .bot { color: #388e3c; font-weight: bold; }
        .bubble { display: inline-block; padding: 8px 12px; border-radius: 16px; max-width: 80%; }
        .bubble.user { background: #e3f2fd; }
        .bubble.bot { background: #e8f5e9; }
        #inputRow { display: flex; gap: 8px; }
        #userInput { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #bbb; }
        #sendBtn { padding: 8px 18px; border-radius: 6px; border: none; background: #1976d2; color: #fff; font-weight: bold; cursor: pointer; }
        #sendBtn:disabled { background: #90caf9; cursor: not-allowed; }
    </style>
</head>
<body>
<div class="container">
    <h2>Chatbot Officina Panarari</h2>
    <div class="session-controls">
        <input type="text" id="sessionId" placeholder="Session ID (opzionale)" />
        <button id="resetBtn" onclick="resetSession()">Reset Sessione</button>
    </div>
    <div id="chat"></div>
    <form id="inputRow">
        <input type="text" id="userInput" placeholder="Scrivi la tua domanda..." autocomplete="off" required />
        <button id="sendBtn" type="submit">Invia</button>
    </form>
</div>
<script>
const API_URL = 'http://localhost:8000/chat';
const RESET_URL = 'http://localhost:8000/reset';
let history = [];
const chatDiv = document.getElementById('chat');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const sessionIdInput = document.getElementById('sessionId');

// Carica session ID dal localStorage
function loadSessionId() {
    const savedSessionId = localStorage.getItem('chatbot_session_id');
    if (savedSessionId) {
        sessionIdInput.value = savedSessionId;
    } else {
        // Genera un session ID casuale se non esiste
        const newSessionId = 'session_' + Math.random().toString(36).substr(2, 9);
        sessionIdInput.value = newSessionId;
        localStorage.setItem('chatbot_session_id', newSessionId);
    }
}

// Salva session ID nel localStorage
function saveSessionId() {
    localStorage.setItem('chatbot_session_id', sessionIdInput.value);
}

// Reset della sessione
async function resetSession() {
    const sessionId = sessionIdInput.value || 'default';
    try {
        const response = await fetch(RESET_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId })
        });
        if (response.ok) {
            history = [];
            renderChat();
            alert('Sessione resettata!');
        } else {
            alert('Errore nel reset della sessione');
        }
    } catch (error) {
        console.error('Errore reset:', error);
        alert('Errore di connessione');
    }
}

function renderChat() {
    chatDiv.innerHTML = '';
    for (const [q, a] of history) {
        chatDiv.innerHTML += `<div class="msg"><span class="user">Utente:</span> <span class="bubble user">${escapeHTML(q)}</span></div>`;
        chatDiv.innerHTML += `<div class="msg"><span class="bot">Bot:</span> <span class="bubble bot">${escapeHTML(a)}</span></div>`;
    }
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

function escapeHTML(str) {
    return str.replace(/[&<>"']/g, function(tag) {
        const chars = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'};
        return chars[tag] || tag;
    });
}

async function sendMessage(event) {
    if (event) event.preventDefault();
    const question = userInput.value.trim();
    if (!question) return false;
    sendBtn.disabled = true;
    userInput.disabled = true;
    history.push([question, '...']);
    renderChat();
    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                user_message: question, 
                history: history.slice(0, -1),
                session_id: sessionIdInput.value || 'default'
            })
        });
        console.log('API response status:', res.status);
        const data = await res.json();
        console.log('API response data:', data);
        if (data.answer) {
            history[history.length-1][1] = data.answer;
        } else {
            history[history.length-1][1] = 'Errore nella risposta del server.';
        }
        renderChat();
    } catch (e) {
        console.error('Errore fetch:', e);
        history[history.length-1][1] = 'Errore di connessione con il server.';
        renderChat();
    }
    userInput.value = '';
    userInput.disabled = false;
    sendBtn.disabled = false;
    userInput.focus();
    return false;
}

document.getElementById('inputRow').addEventListener('submit', sendMessage);

userInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
    }
});

// Salva session ID quando cambia
sessionIdInput.addEventListener('change', saveSessionId);
sessionIdInput.addEventListener('blur', saveSessionId);

// Inizializza
loadSessionId();
renderChat();
</script>
</body>
</html> 